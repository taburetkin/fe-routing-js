(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("@babel/runtime/regenerator"),require("@babel/runtime/helpers/toConsumableArray"),require("@babel/runtime/helpers/asyncToGenerator"),require("@babel/runtime/helpers/typeof"),require("@babel/runtime/helpers/defineProperty"),require("@babel/runtime/helpers/classCallCheck"),require("@babel/runtime/helpers/createClass")):"function"==typeof define&&define.amd?define(["@babel/runtime/regenerator","@babel/runtime/helpers/toConsumableArray","@babel/runtime/helpers/asyncToGenerator","@babel/runtime/helpers/typeof","@babel/runtime/helpers/defineProperty","@babel/runtime/helpers/classCallCheck","@babel/runtime/helpers/createClass"],b):(a=a||self,a.routing=b(a._regeneratorRuntime,a._toConsumableArray,a._asyncToGenerator,a._typeof,a._defineProperty,a._classCallCheck,a._createClass))})(this,function(a,b,c,d,e,f,g){'use strict';function h(a,b){return null==a?new URL(document.location.toString()):a instanceof URL?a:/^https*:\/\//.test(a)?new URL(a):(a=i(a),b&&(a=document.location.pathname+document.location.search+"#"+a),new URL(a,document.location.origin))}function i(a){return a=a.toString(),a.startsWith("/")||(a="/"+a),a}function j(a,b){if(a=h(a,b),b){var c=a.hash.substring(1);return c}return a.pathname+a.search+a.hash}function k(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function l(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?k(b,!0).forEach(function(c){e(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):k(b).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}a=a&&a.hasOwnProperty("default")?a["default"]:a,b=b&&b.hasOwnProperty("default")?b["default"]:b,c=c&&c.hasOwnProperty("default")?c["default"]:c,d=d&&d.hasOwnProperty("default")?d["default"]:d,e=e&&e.hasOwnProperty("default")?e["default"]:e,f=f&&f.hasOwnProperty("default")?f["default"]:f,g=g&&g.hasOwnProperty("default")?g["default"]:g;var m={routingOptions:{},useHashes:!1,isStarted:!1},n=function(){function a(){f(this,a),this.items=[],this.byPath={}}return g(a,[{key:"get",value:function(a){if(null!=a)return a=j(a,m.useHashes),this.byPath[a]}},{key:"add",value:function(a){this.items.push(a),this.byPath[a.path]=a}},{key:"remove",value:function(a){if(null!=a){if("string"==typeof a)return this.remove(this.get(a));if(a instanceof m.RouteHandler){var b=this.items.indexOf(a);return-1==b?void 0:(this.items.splice(b,1),delete this.byPath[a.path],a)}}}},{key:"has",value:function(a){return this.get(a.toString())instanceof m.RouteHandler}},{key:"length",get:function(){return this.items.length}}]),a}(),o=0,p=function(){function e(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};f(this,e),this.options=l({},a),this._routesByPath={},this.routes=new n,this._globalMiddlewares=[],this.setErrorHandlers(this.errorHandlers,a.errorHandlers)}return g(e,[{key:"start",value:function(a){"object"!=d(a)&&(a={}),this._ensureStarted(!0),m.isStarted=!0,a.errorHandlers&&this.setErrorHandlers(a.replaceErrorHandlers,a.errorHandlers),null!=a.useHashes&&(m.useHashes=!0===a.useHashes);var b=Object.assign({},a,{pushState:!1});return!1!==a.trigger&&this.navigate(b),this._setOnPopstate(b),this}},{key:"_setOnPopstate",value:function(a){var b=this;window.onpopstate=function(c){var d=l({},a);d.state=c.state,b.navigate(d)}}},{key:"stop",value:function(){return m.isStarted=!1,window.onpopstate=null,this}},{key:"isStarted",value:function(){return!0===m.isStarted}},{key:"use",value:function(a,b){return("function"==typeof a&&(b=a,a=null),"function"!=typeof b)?this:(a?this.add(a,[b],!0):this._addGlobalMiddleware(b),this)}},{key:"get",value:function(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];return this.add(a,c),this}},{key:"add",value:function(a,b,c){if(null!=a){var d=this._ensureRouteHanlder(a);return d.addMiddlewares(b,c),d}}},{key:"remove",value:function(a,b){"function"==typeof a&&(b=a,a=null);var c=this.routes.get(a);return!c&&b?void this._removeGlobalMiddleware(b):c?(b?c.removeMiddleware(b):this.routes.remove(c),c):void 0}},{key:"_ensureRouteHanlder",value:function(a){var b=this.routes.get(a);return b||(b=new m.RouteHandler(a),this.routes.add(b)),b}},{key:"_removeGlobalMiddleware",value:function(a){var b=this._globalMiddlewares.indexOf(a);-1!==b&&this._globalMiddlewares.splice(b,1)}},{key:"_addGlobalMiddleware",value:function(a){this._globalMiddlewares.push(a)}},{key:"createRequestContext",value:function(a,b){return new m.RequestContext(this._getUrl(a),b)}},{key:"createResponseContext",value:function(a){return new m.ResponseContext(a)}},{key:"_processRequest",value:function(){var d=c(a.mark(function c(d,e){var f,g,h;return a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(f=this.createRequestContext(d,e),g=this.createResponseContext(f),h=this.findRouteHandler(f),!h){a.next=9;break}return a.next=6,h.processRequest(f,g,{globalMiddlewares:b(this._globalMiddlewares)});case 6:g.error&&this.handleError(g.error,f,g),a.next=10;break;case 9:this.handleError("notfound",f,g);case 10:case"end":return a.stop();}},c,this)}));return function(){return d.apply(this,arguments)}}()},{key:"findRouteHandler",value:function(a){a=this._getReq(a);var b=!0,c=!1,d=void 0;try{for(var e,f,g=this.routes.items[Symbol.iterator]();!(b=(e=g.next()).done);b=!0)if(f=e.value,this.testRouteHandler(a,f))return f}catch(a){c=!0,d=a}finally{try{b||null==g["return"]||g["return"]()}finally{if(c)throw d}}}},{key:"testRouteHandler",value:function(a,b){return a=this._getReq(a),b.testRequest(a)}},{key:"handleError",value:function(a,b,c){var d=this.getErrorHandlerName(a),e=this._errorHandlers["default"],f=this._errorHandlers[d];return"function"==typeof f?void f.call(this,a,b,c):void("default"!==d&&e&&e.call(this,a,b,c))}},{key:"getErrorHandlerName",value:function(a){return a instanceof Error?"exception":"string"==typeof a?a:"default"}},{key:"setErrorHandlers",value:function(a){for(var b=arguments.length,c=Array(1<b?b-1:0),d=1;d<b;d++)c[d-1]=arguments[d];a||c.unshift(this._errorHandlers),this._errorHandlers=Object.assign.apply(Object,[{}].concat(c))}},{key:"navigate",value:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return(this._ensureStarted(),"object"===d(a)&&(b=a,a=null),!this.isCurrentUrl(a))&&(!1!==b.trigger&&this._processRequest(a,b),this.setCurrentUrl(a),!1!==b.pushState&&this.browserPushState(a,b),!0)}},{key:"isCurrentUrl",value:function(a){return a=this._getUrl(a),this._currentUrl==a.toString().toLowerCase()}},{key:"setCurrentUrl",value:function(a){a=this._getUrl(a),this._currentUrl=a.toString().toLowerCase()}},{key:"browserPushState",value:function(a){a=this._getUrl(a);var b=this.getCurrentState();history.pushState(b,document.title,a.toString())}},{key:"getCurrentState",value:function(){return{counter:++o}}},{key:"_ensureStarted",value:function(){var a=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0],b=a?"already":"not yet";if(this.isStarted()===a)throw new Error("Routing ".concat(b," started"));return this}},{key:"_getUrl",value:function(a){return h(a,m.useHashes)}},{key:"_getReq",value:function(a){return a instanceof m.RequestContext?a:this.createRequestContext(a)}}]),e}(),q=function(){function d(a){f(this,d),this.url=this._getUrl(a),this.path=this._buildPath(),this.pattern=this._buildPattern(),this.middlewares=[]}return g(d,[{key:"_getUrl",value:function(a){return h(a,m.useHashes)}},{key:"_buildPath",value:function(){return j(this.url,m.useHashes)}},{key:"_buildPattern",value:function(){var a=this.regexOptions,b=this.path.replace(a.escapeRegExp,"\\$&").replace(a.optionalParam,"(?:$1)?").replace(a.namedParam,function(a,b){return b?a:"([^/?]+)"}).replace(a.splatParam,"([^?]*?)");return new RegExp("^"+b+"(?:\\?([\\s\\S]*))?$")}},{key:"addMiddlewares",value:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f,g=a[Symbol.iterator]();!(b=(e=g.next()).done);b=!0)f=e.value,this.addMiddleware(f)}catch(a){c=!0,d=a}finally{try{b||null==g["return"]||g["return"]()}finally{if(c)throw d}}}},{key:"addMiddleware",value:function(a){if("function"!=typeof a)throw new Error("middleware must be a function");this.middlewares.push(a)}},{key:"removeMiddleware",value:function(a){var b=this.middlewares.indexOf(a);if(!(0>b))return this.middlewares.splice(b,1),a}},{key:"removeMiddlewares",value:function(a){if(null==a)return void(this.middlewares.length=0);if(!Array.isArray(a))throw new Error("argument is not an array");var b=!0,c=!1,d=void 0;try{for(var e,f,g=a[Symbol.iterator]();!(b=(e=g.next()).done);b=!0)f=e.value,this.removeMiddleware(f)}catch(a){c=!0,d=a}finally{try{b||null==g["return"]||g["return"]()}finally{if(c)throw d}}}},{key:"hasMiddleware",value:function(a){return-1<this.middlewares.indexOf(a)}},{key:"processRequest",value:function(){var d=c(a.mark(function c(d,e){var f,g,h,i,j,k=arguments;return a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return f=2<k.length&&void 0!==k[2]?k[2]:{},this.prepareRequestContext(d),g=f.globalMiddlewares,h=void 0===g?[]:g,i=[].concat(b(h),b(this.middlewares)),j=this._createNextHandler(d,e,i),a.next=7,j();case 7:return a.abrupt("return",a.sent);case 8:case"end":return a.stop();}},c,this)}));return function(){return d.apply(this,arguments)}}()},{key:"_createNextHandler",value:function(b,d,e){var f=e.shift();if(!f)return function(){};var g=this._createNextHandler(b,d,e);return c(a.mark(function c(){return a.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!d.isEnded()){a.next=2;break}return a.abrupt("return",d.error);case 2:return a.next=4,f(b,d,g);case 4:return a.abrupt("return",a.sent);case 5:case"end":return a.stop();}},c)}))}},{key:"prepareRequestContext",value:function(a){var b=this.pattern.exec(a.path).slice(1),c=this.pattern.exec(this.path).slice(1),d=c.reduce(function(a,c,d){return null==c?a:(a[c.substring(1)]=b[d],a)},{});Object.assign(a.args,d)}},{key:"testRequest",value:function(a){return this.pattern.test(a.path)}}]),d}();Object.assign(q.prototype,{regexOptions:{optionalParam:/\((.*?)\)/g,namedParam:/(\(\?)?:\w+/g,splatParam:/\*\w+/g,escapeRegExp:/[-{}[\]+?.,\\^$|#\s]/g}});var r=function(){function a(b,c){f(this,a),this.options=c,this.url=this._getUrl(b),this.path=this._buildPath(),this.args={},this.search=this._buildSearch(),c&&c.state&&(this.state=c.state)}return g(a,[{key:"_getUrl",value:function(a){return h(a,m.useHashes)}},{key:"_buildPath",value:function(){return j(this.url,m.useHashes)}},{key:"_buildSearch",value:function(){var a={},b=!0,c=!1,d=void 0;try{for(var e,f,g=this.url.searchParams.keys()[Symbol.iterator]();!(b=(e=g.next()).done);b=!0)f=e.value,a[f]=this.url.searchParams.getAll(f),1===a[f].length&&(a[f]=a[f][0])}catch(a){c=!0,d=a}finally{try{b||null==g["return"]||g["return"]()}finally{if(c)throw d}}return a}}]),a}(),s=function(){function a(b){f(this,a),this.request=b,this._processing=!0,this.locals={}}return g(a,[{key:"isOk",value:function(){return!this.error}},{key:"end",value:function(){return this._processing=!1,this}},{key:"isEnded",value:function(){return!1==this._processig}},{key:"setError",value:function(a){return this.error=a,this}},{key:"notFound",value:function(){return this.setError("notfound"),this}},{key:"notAllowed",value:function(){return this.setError("notallowed"),this}}]),a}();m.Routing=p,m.RouteHandler=q,m.RequestContext=r,m.ResponseContext=s;return{_ensureRouting:function(){return this.instance||(this.instance=this.createRouting()),this.instance},createRouting:function(){return new m.Routing(m.routingOptions)},get:function(){var a;return(a=this._ensureRouting()).get.apply(a,arguments)},use:function(){var a;return(a=this._ensureRouting()).use.apply(a,arguments)},isStarted:function(){return!!this.instance&&this.instance.isStarted()},start:function(){var a;return(a=this._ensureRouting()).start.apply(a,arguments)},stop:function(){var a;return this.isStarted()&&(a=this.instance).stop.apply(a,arguments)},remove:function(){var a;return this.instance?(a=this.instance).remove.apply(a,arguments):void 0},navigate:function(){var a;return(a=this._ensureRouting()).navigate.apply(a,arguments)},config:m}});
